using Colossal.Menu;
using Colossal.Patches;
using ExitGames.Client.Photon;
using GorillaNetworking;
using GorillaTagScripts;
using HarmonyLib;
using Photon.Pun;
using Photon.Realtime;
using Photon.Voice.Unity;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

namespace Colossal.Mods
{
    public class SpazAllCosmeics : MonoBehaviour
    {
        private Coroutine spamCoroutine;
        private bool isSpamming;

        private void Update()
        {
            if (!PhotonNetwork.IsConnectedAndReady)
            {
                StopSpamming();
                return;
            }

            if (PluginConfig.spazallcosmetics)
            {
                if (!isSpamming)
                {
                    isSpamming = true;
                    spamCoroutine = StartCoroutine(SpamAllCosmeticsCoroutine());
                }

                RPCProtection.SkiddedRPCProtection();
            }
            else
            {
                StopSpamming();
                Destroy(this); // cleaner
            }
        }

        private IEnumerator SpamAllCosmeticsCoroutine()
        {
            CosmeticsController controller = CosmeticsController.instance;

            if (controller == null)
            {
                Debug.Log("[COLOSSAL] CosmeticsController instance not found.");
                isSpamming = false;
                yield break;
            }

            var categories =
                (CosmeticsController.CosmeticCategory[])System.Enum.GetValues(
                    typeof(CosmeticsController.CosmeticCategory)
                );

            while (isSpamming && PhotonNetwork.IsConnectedAndReady)
            {
                foreach (var category in categories)
                {
                    int count = controller.GetCategorySize(category);
                    if (count <= 0) continue;

                    int index = Random.Range(0, count);
                    var cosmetic = controller.GetCosmetic(category, index);

                    if (cosmetic.isNullItem)
                        continue;

                    controller.PressWardrobeItemButton(cosmetic, false);

                    yield return new WaitForSeconds(0.1f);
                }
            }

            isSpamming = false;
        }

        private void StopSpamming()
        {
            if (spamCoroutine != null)
            {
                StopCoroutine(spamCoroutine);
                spamCoroutine = null;
            }

            isSpamming = false;
        }
    }
}

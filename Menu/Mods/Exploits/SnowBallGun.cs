using ExitGames.Client.Photon;
using Mercury.Console;
using Mercury.Menu;
using Mercury.Patches;
using Photon.Pun;
using Photon.Realtime;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

namespace Mercury.Mods
{
    public class SnowBallGun : MonoBehaviour
    {
        public float delay = 0.2f;
        // Credits to iiDk 
        public static SnowballThrowable[] snowballs = new SnowballThrowable[] { };
        public static Dictionary<string, SnowballThrowable> snowballDict;
        private static Coroutine rigCoroutine;
        public Coroutine DisableCoroutine;
        void Update()
        {
            if (!PluginConfig.snowballgun || !PhotonNetwork.InRoom)
                return;

            string bind = CustomBinding.GetBinds("snowballgun");
            if (string.IsNullOrEmpty(bind) || bind == "UNBOUND")
                return;

            if (ControlsV2.GetControl(bind))
            {
                SpawnSnowball("GrowingSnowballRightAnchor", GorillaTagger.Instance.rightHandTransform.position, GorillaTagger.Instance.rightHandTransform.forward * 50f);
            }
        }

        // Credits to iiDk 
        IEnumerator EnableRig()
        {
            yield return new WaitForSeconds(delay + 0.2f);
            if (VRRig.LocalRig != null) VRRig.LocalRig.enabled = true;
        }
        IEnumerator DisableProjectile(SnowballThrowable throwable)
        {
            yield return new WaitForSeconds(delay + 0.2f);
            if (throwable != null) throwable.SetSnowballActiveLocal(false);
        }
        // Credits to iiDk | Rewrote alil - nova
        void SpawnSnowball(string projectileName, Vector3 position, Vector3 velocity)
        {
            SnowballThrowable throwable = GetProjectile(projectileName);
            if (throwable == null) return;
            throwable.SetSnowballActiveLocal(true);
            throwable.transform.position = position;
            throwable.transform.rotation = Quaternion.LookRotation(velocity);
            if (DisableCoroutine != null) CoroutineManager.instance.StopCoroutine(DisableCoroutine);
            DisableCoroutine = CoroutineManager.instance.StartCoroutine(DisableProjectile(throwable));
            try
            {
                if (Vector3.Distance(GorillaTagger.Instance.bodyCollider.transform.position, position) > 3.9f)
                {
                    VRRig.LocalRig.enabled = false;
                    VRRig.LocalRig.transform.position = position + Vector3.down * 2f;
                    if (rigCoroutine != null) CoroutineManager.instance.StopCoroutine(rigCoroutine);
                    rigCoroutine = CoroutineManager.instance.StartCoroutine(EnableRig());
                }
                GrowingSnowballThrowable growing = throwable as GrowingSnowballThrowable;
                if (growing == null) return;
                int scale = 5;
                int index = GetProjectileIncrement(position, velocity, throwable.transform.lossyScale.x );
                RaiseEventOptions options = new RaiseEventOptions { Receivers = ReceiverGroup.All };
                PhotonNetwork.RaiseEvent(176, new object[] { growing.changeSizeEvent._eventId, scale }, options, new SendOptions { Reliability = false, Encrypt = true });
                PhotonNetwork.RaiseEvent(176, new object[] { growing.snowballThrowEvent._eventId, position, velocity, index },options, new SendOptions { Reliability = false, Encrypt = true });
            }
            finally
            {
                if (VRRig.LocalRig != null) VRRig.LocalRig.enabled = true;
            }
        }

        static SnowballThrowable GetProjectile(string projectileName)
        {
            if (snowballDict == null)
            {
                if (!CosmeticsV2Spawner_Dirty.allPartsInstantiated)
                    return null;

                snowballDict = new Dictionary<string, SnowballThrowable>();

                foreach (SnowballMaker maker in new[] { SnowballMaker.leftHandInstance, SnowballMaker.rightHandInstance })
                {
                    foreach (SnowballThrowable t in maker.snowballs)
                    {
                        string name = t.transform.parent.gameObject.name;
                        if (!snowballDict.ContainsKey(name)) snowballDict.Add(name, t);
                    }
                }
            }

            projectileName += "(Clone)";
            return snowballDict.TryGetValue(projectileName, out var proj) ? proj : null;
        }
        static int archiveIncrement;
        static int GetProjectileIncrement(Vector3 position, Vector3 velocity, float scale)
        {
            try
            {
                GameObject go = new GameObject("SlingshotProjectileHolder");
                SlingshotProjectile proj = go.AddComponent<SlingshotProjectile>();
                int id = ProjectileTracker.AddAndIncrementLocalProjectile(proj, velocity, position, scale);
                Object.Destroy(go);
                archiveIncrement = id;
                return id;
            }
            catch
            {
                archiveIncrement++;
                return archiveIncrement;
            }
        }
    }
}